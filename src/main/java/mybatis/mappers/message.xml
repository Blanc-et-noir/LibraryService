<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="message">

	<insert id="sendMessageReceived" parameterType="java.util.HashMap">
		<![CDATA[
			INSERT INTO ${MESSAGE_BOX}
			VALUES(MESSAGE_RECEIVED_SEQUENCE.NEXTVAL,#{SENDER_ID},#{RECEIVER_ID},#{MESSAGE_TITLE},#{MESSAGE_CONTENT},SYSDATE)
		]]>
	</insert>
	<insert id="sendMessageSent" parameterType="java.util.HashMap">
		<![CDATA[
			INSERT INTO ${MESSAGE_BOX}
			VALUES(MESSAGE_SENT_SEQUENCE.NEXTVAL,#{SENDER_ID},#{RECEIVER_ID},#{MESSAGE_TITLE},#{MESSAGE_CONTENT},SYSDATE)
		]]>
	</insert>
	
	
	<delete id="deleteMessage" parameterType="java.util.HashMap">
		DELETE FROM ${MESSAGE_BOX}
		WHERE ${OWNER_ID} = #{CUSTOMER_ID} AND MESSAGE_ID IN <foreach collection="LIST" open="(" close=")" separator="," item="item">${item}</foreach>
	</delete>
	
	
	
	<select id="getNewMessageID" resultType="Integer" parameterType="String">
		<![CDATA[
			SELECT MAX(MESSAGE_ID)
			FROM ${MESSAGE_BOX}
		]]>
	</select>
	<select id="getMessageCount" parameterType="java.util.HashMap" resultType="Integer">
		<![CDATA[
			SELECT COUNT(*)
			FROM ${MESSAGE_BOX}
			WHERE ${OWNER_ID} = #{CUSTOMER_ID} AND (MESSAGE_TITLE LIKE '%'||#{SEARCH}||'%' OR MESSAGE_CONTENT LIKE '%'||#{SEARCH}||'%' OR ${TARGET_ID} LIKE '%'||#{SEARCH}||'%')
		]]>
	</select>
	<!--
	<select id="receiveMessage" parameterType="java.util.HashMap" resultType="java.util.HashMap">	
		<![CDATA[
			SELECT *
			FROM (
				SELECT ROWNUM IDX, MESSAGE_ID, SENDER_ID, RECEIVER_ID, MESSAGE_TITLE, MESSAGE_CONTENT, MESSAGE_DATE_STRING
				FROM (
					SELECT MESSAGE_ID, SENDER_ID, RECEIVER_ID, MESSAGE_TITLE, MESSAGE_CONTENT, TO_CHAR(MESSAGE_DATE,'YYYY.MM.DD HH24:MI:SS') MESSAGE_DATE_STRING
					FROM ${MESSAGE_BOX}
					ORDER BY ${ORDERBY})
				WHERE ${OWNER_ID} = #{CUSTOMER_ID} AND (MESSAGE_TITLE LIKE '%'||#{SEARCH}||'%' OR MESSAGE_CONTENT LIKE '%'||#{SEARCH}||'%' OR ${TARGET_ID} LIKE '%'||#{SEARCH}||'%'))
			WHERE IDX >= (((${SECTION}-1)*100)+((${PAGE}-1)*10)+1) AND IDX <= ((${SECTION}-1)*100+(${PAGE})*10)
		]]>
	</select>
	-->
	<select id="receiveMessage" parameterType="java.util.HashMap" resultType="java.util.HashMap">	
		<![CDATA[
			SELECT *
			FROM(
				SELECT ROW_NUMBER() OVER(ORDER BY ${ORDERBY}) IDX, MESSAGE_ID, SENDER_ID, RECEIVER_ID, MESSAGE_TITLE, MESSAGE_CONTENT, TO_CHAR(MESSAGE_DATE,'YYYY.MM.DD HH24:MI:SS') MESSAGE_DATE_STRING
				FROM ${MESSAGE_BOX}
				WHERE ${OWNER_ID} = #{CUSTOMER_ID} AND (MESSAGE_TITLE LIKE '%'||#{SEARCH}||'%' OR MESSAGE_CONTENT LIKE '%'||#{SEARCH}||'%' OR ${TARGET_ID} LIKE '%'||#{SEARCH}||'%')
			)
			WHERE IDX >= (((${SECTION}-1)*100)+((${PAGE}-1)*10)+1) AND IDX <= ((${SECTION}-1)*100+(${PAGE})*10)
		]]>
	</select>
	
	<select id="readMessage" parameterType="java.util.HashMap" resultType="com.spring.LibraryService.vo.MessageVO">
		<![CDATA[
			SELECT *
			FROM ${MESSAGE_BOX}
			WHERE MESSAGE_ID = ${MESSAGE_ID} AND ${OWNER_ID} = #{CUSTOMER_ID}
		]]>
	</select>
</mapper>